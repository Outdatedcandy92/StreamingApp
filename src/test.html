<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebTorrent Video Stream with HLS.js</title>
  <style>
    #output video {
      width: 100%;
    }
  </style>
</head>
<body>
  <div>
    <input type="text" id="magnetInput" placeholder="Enter magnet link here" style="width: 80%;">
    <button id="startStream">Start Stream</button>
  </div>
  <div id="output">
    <video id="videoPlayer" controls></video>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

  <script>
    document.getElementById('startStream').addEventListener('click', function() {
      const magnetURI = document.getElementById('magnetInput').value;
      if (!magnetURI) {
        alert('Please enter a magnet link.');
        return;
      }

      const client = new WebTorrent();
      console.log('WebTorrent client initialized');

      const trackers = [
        'wss://tracker.openwebtorrent.com',
        'wss://tracker.btorrent.xyz',
        'wss://tracker.fastcast.nz',
        'wss://tracker.webtorrent.io'
      ];

      client.add(magnetURI, { announce: trackers }, function (torrent) {
        console.log('Torrent added:', torrent);


        torrent.files.forEach(function (file) {
          console.log('File in torrent:', file.name);
        });

        const file = torrent.files.find(function (file) {
          return file.name.endsWith('.mp4');
        });

        if (file) {
          console.log('Found .mp4 file:', file.name);
          file.getBlobURL(function (err, url) {
            if (err) {
              console.error('Error getting blob URL:', err);
              return;
            }
            const video = document.getElementById('videoPlayer');
            if (Hls.isSupported()) {
              const hls = new Hls();
              hls.loadSource(url);
              hls.attachMedia(video);
              hls.on(Hls.Events.MANIFEST_PARSED, function () {
                video.play().catch(error => {
                  console.error('Error playing video:', error);
                });
              });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
              video.src = url;
              video.addEventListener('loadedmetadata', function () {
                video.play().catch(error => {
                  console.error('Error playing video:', error);
                });
              });
            } else {
              console.error('HLS not supported in this browser.');
            }
          });
        } else {
          console.error('No .mp4 file found in the torrent.');
        }
      });

      client.on('error', function (err) {
        console.error('Error with WebTorrent client:', err);
      });

  
      const videoPlayer = document.getElementById('videoPlayer');
      videoPlayer.addEventListener('error', function (event) {
        console.error('Video element error:', event);
      });
      videoPlayer.addEventListener('waiting', function () {
        console.log('Video is waiting for more data...');
      });
      videoPlayer.addEventListener('canplay', function () {
        console.log('Video can start playing.');
      });
      videoPlayer.addEventListener('playing', function () {
        console.log('Video is playing.');
      });
      videoPlayer.addEventListener('progress', function () {
        console.log('Video is buffering...');
      });
      videoPlayer.addEventListener('loadeddata', function () {
        console.log('Video data loaded.');
      });
      videoPlayer.addEventListener('loadedmetadata', function () {
        console.log('Video metadata loaded.');
      });
      videoPlayer.addEventListener('stalled', function () {
        console.log('Video playback stalled.');
      });
    });
  </script>
</body>
</html>